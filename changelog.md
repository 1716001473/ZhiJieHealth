# 📝 Changelog - 智能食物识别健康助手


## 2026-02-06 个人资料编辑与头像上传 📸✏️

### 功能概述

新增个人资料编辑页面，支持头像上传（带裁切功能）、昵称修改和密码修改功能。

### 核心功能

**1. 头像上传与裁切**
- **图片选择**：支持从相册选择或拍照获取图片
- **可视化裁切**：使用 `movable-area` + `movable-view` 实现拖动和缩放
- **圆形预览**：裁切框为圆形，实时预览头像效果
- **Canvas 导出**：裁切后通过 Canvas 导出 400x400 的正方形图片
- **文件上传**：使用 `uni.uploadFile` 上传到后端

**2. 昵称编辑**
- 支持修改用户昵称（最多 20 字符）
- 保存后同步更新本地存储

**3. 密码修改**
- 独立的密码修改页面
- 验证旧密码后才能设置新密码
- 新密码至少 6 位
- 修改成功后自动退出登录，要求重新登录

### 技术实现

**后端改动：**

| 文件 | 改动说明 |
|------|----------|
| `app/main.py` | 新增 `StaticFiles` 挂载，支持静态文件访问 |
| `app/api/v1/user.py` | 新增 `/user/avatar` (Base64) 和 `/user/avatar/upload` (文件) 两种头像上传接口 |
| `app/api/v1/user.py` | 新增 `/user/password` 密码修改接口 |
| `app/schemas/user.py` | 新增 `ChangePasswordRequest`、`AvatarUploadRequest`、`AvatarUploadResponse` |

**前端改动：**

| 文件 | 改动说明 |
|------|----------|
| `pages/profile/edit.vue` | **新增** 个人资料编辑页面，含头像裁切功能 |
| `pages/profile/password.vue` | **新增** 密码修改页面 |
| `pages/profile/index.vue` | 头像区域可点击进入编辑页面，新增 `getAvatarUrl()` 函数 |
| `pages.json` | 新增 `profile/edit` 和 `profile/password` 页面路由，设置自定义导航栏 |
| `vite.config.ts` | 新增 `/static` 路径代理，支持 H5 环境访问静态资源 |

### Bug 修复

**1. 头像上传后不显示**
- **原因**：后端未配置静态文件服务 + 前端 Vite Proxy 未代理 `/static` 路径
- **修复**：后端添加 `StaticFiles` 挂载，前端添加 `/static` 代理

**2. 顶部标题栏重复**
- **原因**：页面同时有系统导航栏和自定义 header 组件
- **修复**：为编辑页面设置 `"navigationStyle": "custom"`

### API 接口

**头像上传（文件方式）：**
```
POST /api/v1/user/avatar/upload
Content-Type: multipart/form-data
Authorization: Bearer <token>

file: <图片文件>
```

**密码修改：**
```
PUT /api/v1/user/password
Authorization: Bearer <token>

{
  "old_password": "旧密码",
  "new_password": "新密码"
}
```

---

## 2026-02-06 食物搜索增强 + 中国食材数据库 🥬🖼️

### 功能概述

优化食物搜索体验，新增 Open Food Facts 图片显示、中国常见食材数据库，并将项目托管到 GitHub。

### 核心改进

**1. Open Food Facts 图片支持**
- **问题**：搜索蒙牛等品牌食品时，虽然能获取到 OFF 数据，但没有显示产品图片
- **方案**：
  - 后端 `FoodResponse` Schema 新增 `image_url` 字段
  - `openfoodfacts_service.py` 提取产品图片 URL
  - 前端搜索结果显示产品图片，无图片时显示 🍽️ 占位符

**2. 中国常见食材数据库**
- **问题**：搜索"娃娃菜"等中国食材时，本地数据库没有，OFF 也搜不到
- **方案**：新增 `chinese_foods_data.py`，基于《中国食物成分表》整理 **56 种常见食材**
- **分类覆盖**：
  - 叶菜类：娃娃菜、大白菜、菠菜、生菜、油麦菜、空心菜、韭菜、芹菜、茼蒿等
  - 瓜果类：黄瓜、西红柿、茄子、冬瓜、南瓜、苦瓜、丝瓜、西葫芦等
  - 根茎类：土豆、红薯、胡萝卜、白萝卜、莲藕、山药、芋头、洋葱、大蒜、生姜等
  - 豆类/菌菇：豆腐、豆腐干、豆芽、香菇、金针菇、木耳、平菇、杏鲍菇等
  - 肉类：猪肉、五花肉、鸡胸肉、鸡腿肉、牛肉、羊肉、鸭肉等
  - 水产：草鱼、鲫鱼、带鱼、虾仁、基围虾等
  - 蛋奶类：鸡蛋、鸭蛋、牛奶
  - 主食类：大米、小米、燕麦、玉米、红豆、绿豆等

**3. 数据来源标识优化**
- 前端搜索结果显示数据来源徽章
- 新增 `OFF数据库` 标识（橙黄色背景）
- 区分：数据库 / AI估算 / 百度热量 / 自定义 / OFF数据库

**4. GitHub 仓库托管**
- 项目已推送至 GitHub：https://github.com/1716001473/ZhiJieHealth
- 采用 Monorepo 结构，包含 `food-health-api` 和 `food-health-app` 两个子项目

### 技术实现

**后端改动：**

| 文件 | 改动说明 |
|------|----------|
| `app/schemas/food.py` | `FoodResponse` 新增 `image_url` 字段 |
| `app/api/v1/food.py` | OFF 搜索结果传递 `image_url` |
| `app/services/openfoodfacts_service.py` | 提取产品图片 URL |
| `app/database/chinese_foods_data.py` | **新增** 56 种中国常见食材数据 |
| `app/database/init_data.py` | 调用 `init_chinese_foods()` 初始化数据 |

**前端改动：**

| 文件 | 改动说明 |
|------|----------|
| `pages/record/add.vue` | 搜索结果显示图片、新增 OFF 数据源标识样式 |

### 数据统计

- 本地食物数据库：**87 条**（原 31 条 + 新增 56 条中国食材）
- 搜索优先级：本地数据库 > Open Food Facts（确保中文食材优先）

---

## 2026-02-06 健康档案图表优化 📊✨

### 功能概述

对健康档案页面的体重趋势图表进行了全面优化，解决了数据密集显示问题，新增时间筛选器和交互式数据点提示功能。

### 核心改进

**1. SVG 文字兼容性修复**
- **问题**：uni-app 小程序环境中 SVG `<text>` 元素不被支持，导致 Y 轴刻度、X 轴日期、数据点数值均无法显示
- **方案**：使用 `view + text` 组件通过绝对定位替代 SVG text 元素，保留 SVG 图形渲染（折线、圆点、柱状图）

**2. 时间筛选器**
- 新增 **7天 / 14天 / 30天** 三个筛选按钮
- 默认显示 7 天数据，点击按钮立即刷新图表
- 按钮样式：未选中灰色背景，选中绿色高亮

**3. 智能数据采样**
- 实现 `sampleData()` 函数，等间隔选取关键数据点
- 无论选择多少天，最多显示 **8 个数据点**
- 保留首尾数据点，中间均匀采样，避免图表过于密集

**4. 点击提示功能**
- 点击数据点显示详细信息提示框（日期 + 数值 + 单位）
- 选中的数据点放大高亮（半径 4→6，边框加粗）
- 再次点击取消选中
- 深色背景 + 箭头设计，视觉效果优雅

**5. 自适应宽度**
- 默认 `width=0` 表示自适应容器宽度
- 使用 `uni.createSelectorQuery()` 获取实际容器宽度
- 手机和电脑上都能良好显示

**6. 视觉优化**
- Y 轴网格线从 5 条减少到 4 条，改为虚线样式
- X 轴标签智能显示：数据点 ≤5 显示全部，>5 只显示首、中、尾
- 减少 padding，给数据趋势更多展示空间
- 折线变细（2.5→2），渐变填充更淡，整体更精致

### 技术实现

**前端改动：**

| 文件 | 改动说明 |
|------|----------|
| `components/HealthChart.vue` | 重构图表组件，SVG+view 混合渲染，新增点击交互和自适应 |
| `pages/health/index.vue` | 新增时间筛选器、`weightDays` 状态、`sampleData()` 采样函数 |

**新增代码结构：**
```typescript
// 数据采样函数
const sampleData = (data: any[], maxPoints: number = 8) => {
  if (data.length <= maxPoints) return data
  const result = []
  const step = (data.length - 1) / (maxPoints - 1)
  for (let i = 0; i < maxPoints; i++) {
    result.push(data[Math.round(i * step)])
  }
  return result
}

// 时间筛选切换
const changeWeightDays = (days: number) => {
  weightDays.value = days
  fetchWeightData()
}
```

### 用户体验提升

- ✅ 图表数值清晰可见，不再密集重叠
- ✅ 灵活切换时间范围，查看不同周期趋势
- ✅ 点击数据点查看精确数值，交互友好
- ✅ 自适应屏幕宽度，移动端/PC 端均适配

---

## 2026-02-03 精选食谱"不感兴趣"功能 ❌🥗

### 功能概述

为"推荐食谱"页面添加了**轻量级"不感兴趣"功能**，用户可以标记不喜欢的食谱，系统会记录偏好并在下次AI生成时自动避开。

### 核心特性

**设计理念：**
- ✅ **极简实现**：前端假删除 + LocalStorage存储，无需复杂CRUD
- ✅ **即时响应**：滑动删除，无网络延迟
- ✅ **真正有效**：Prompt注入直接影响AI生成结果
- ✅ **越用越准**：持续学习用户偏好

**用户体验流程：**
```
向左滑动食谱 → 显示"不感兴趣" → 点击删除 → 立即消失
  ↓
【可选】反馈原因：食材不喜欢 / 做法太难 / 热量太高
  ↓
存储到 LocalStorage
  ↓
下次生成AI食谱时 → Prompt自动注入："用户不喜欢：芹菜、复杂做法"
  ↓
AI生成更符合偏好的食谱 ✨
```

### 技术实现

**前端（Vue 3 + TypeScript）：**
- 滑动删除交互：向左滑动显示红色删除按钮
- 假删除：直接从数组移除，无需等待后端响应
- LocalStorage偏好存储：`{ dislikedTags: ["芹菜", "海鲜", "复杂做法"] }`
- 可选反馈弹窗：智能提取食材/做法/热量标签
- 生成食谱时传递偏好：`POST /api/v1/plans/generate` 携带 `disliked_tags`

**后端（FastAPI + Python）：**
- API Schema扩展：`PlanGenerateRequest` 新增 `disliked_tags: List[str]` 字段
- 接口参数传递：`generate_plan` 接收并传递给DeepSeek服务
- Prompt注入：`generate_diet_plan` 方法注入用户不喜欢的标签
  ```python
  if disliked_tags:
      prompt += f"""
      ⚠️ 用户历史反馈不喜欢：{disliked_tags}
      请严格避开以上内容，不要推荐包含这些元素的食谱。
      """
  ```

### 数据结构

**LocalStorage示例：**
```json
{
  "userPreference": {
    "dislikedTags": ["芹菜", "海鲜", "复杂做法", "高热量"],
    "lastUpdated": 1738569600000
  }
}
```

**API请求示例：**
```json
POST /api/v1/plans/generate
{
  "health_goal": "lose_weight",
  "dietary_preferences": "清淡",
  "disliked_tags": ["芹菜", "海鲜", "复杂做法"]
}
```

### 核心优势

- **极简设计**：仅 ~230 行代码完成完整功能
- **无过度设计**：不做用户不需要的恢复功能
- **关注核心价值**："越推越准"而非"完美的删除系统"
- **用户友好**：流畅的滑动交互，符合用户习惯

### 代码量统计

| 模块 | 文件 | 新增行数 |
|------|------|---------|
| 前端 | `pages/plan/index.vue` | ~150 |
| 后端 | `api/v1/plan.py` | ~5 |
| 后端 | `services/deepseek_service.py` | ~20 |

**开发时间**: 约 1.5 小时

---

## 2026-02-02 AI 食谱生成修复与标签优化 🤖🥘

### 修复 500 错误 (Fix 500 Error)

**问题**：点击生成推荐食谱时，后端报错 `500 Internal Server Error`。
**原因**：
1. `app/api/v1/plan.py` 缺少 `deepseek_service` 导入。
2. AI 服务调用未做异常捕获，导致超时或错误时直接崩溃。
3. 当 Token 有效但用户被删除时，访问用户信息导致空指针异常。

**修复**：
- 补充缺失导入。
- 增加 `try-except` 块包裹 AI 调用，实现自动降级到 Mock 数据。
- 增加用户信息判空逻辑，增强系统健壮性。

### 食谱标签智能优化 (Smart Tags)

**功能**：AI 生成的食谱现在会自动打上标准化的分类标签（如“减脂”、“低碳水”、“增肌”等），解决了前端筛选器无法根据标签筛选 AI 食谱的问题。

**实现**：
- 优化 DeepSeek Prompt，强制 AI 从预定义标签集中选择最匹配的 1-3 个标签。
- 后端自动合并 AI 标签与系统标签（AI定制, DeepSeek）。
- 前端筛选功能现已完美支持 AI 生成的食谱。

### 数据清理 (Data Cleanup)

- **执行了深度清理脚本**：彻底删除了数据库中所有旧的食谱计划及残留的每日/每餐数据，确保新生成的食谱数据纯净可靠。

---

## 2026-01-30 推荐食谱与个性化计划 🥗📅

### 推荐食谱系统 (Diet Plan System)

新增了完整的“推荐食谱”模块，帮助用户依据健康目标获取科学的饮食计划。

**功能亮点：**
- **食谱库与筛选**：提供“CRD 21天减肥”、“高蛋白增肌”等专业食谱，支持按标签（减肥、增肌、低卡）筛选。
- **每日计划详情**：以时间轴形式展示周期性计划（7-21天），每日三餐安排清晰可见。
- **智能一键应用**：支持将食谱中某日的建议餐单，一键导入到用户的今日饮食记录中，省去手动录入的繁琐。
- **个性化设置**：在个人中心增加“健康目标”（减重/增肌/维持）和“饮食偏好”设置，为 AI 推荐提供依据。

### 修复与优化 (Fixes & Improvements)

- **登录 500 错误修复**：解决了因数据库表结构缺失（`health_goal` 字段）导致的登录失败问题，增加了自动迁移脚本。
- **前端路由修复**：修复了“推荐食谱”页面点击报错的问题，手动补全了 `pages.json` 中的页面注册。
- **后端启动修复**：修复了 `plan.py` 中遗漏 `date` 引用导致的启动报错。
- **个人设置入口修复**：在“我的”页面补充了遗漏的“个人设置”入口，方便用户修改健康目标。
- **登录状态持久化**：将 Token 机制升级为无状态 JWT (HMAC)，彻底解决后端重启导致用户掉线 (401) 的问题。

---

## 2026-01-29 饮食记录体验升级 + 游客模式 + 临时食物库 🧾⚡

### AI 识别精度修复（西红柿/生鲜误判） 🍅

**问题**：部分生鲜食材（如西红柿、土豆）被百度 AI “菜品识别”模型强制误判为煮熟的菜肴（如“非菜”），导致识别错误。

**修复方案**：
- **模型优选策略**：引入多模型竞争机制，当“果蔬/食材识别”模型置信度 > 80% 时，优先采纳其结果，覆盖“菜品识别”的误判。
- **接口修正**：修复了百度 AI 果蔬识别接口 (Ingredient) 的 URL 配置错误。

### AI 识别结果自动写入临时食物表

当识别结果不在本地数据库时，会自动写入 `food_temp` 临时表，并在搜索中可直接命中。

**功能亮点：**

- **AI 兜底入库**：DeepSeek/百度热量结果自动写入临时表。
- **来源标记**：前端搜索结果显示数据来源（数据库/AI/百度/自定义）。
- **搜索融合**：`/api/v1/food` 同时检索本地库与临时库，避免“搜不到”。

### 添加饮食流程增强（餐具估算 + 批量添加）

**功能亮点：**

- **餐具估算**：一小碗/一碗/一盘/一大盘快速换算重量。
- **批量清单**：可一次加入多种食物，统一提交。
- **按项餐次选择**：批量清单内每条可单独选择餐次。
- **添加后定位**：添加成功自动回到饮食记录页并定位到对应餐次区域。

### 报表与登录体验优化

- **卡路里环形图**：日报顶部改为环形进度显示摄入占比。
- **骨架屏**：饮食记录页加载中显示骨架屏。
- **游客模式**：历史记录支持游客访问空列表（可通过配置开关控制）。
- **统一 401 拦截**：前端请求遇到 401 自动清理登录态并提示。

### 目标热量自定义与推荐营养自动计算

- **目标热量设置**：用户可在饮食记录页设置每日目标热量（本地持久化）。
- **推荐营养联动**：根据目标热量自动换算推荐碳水/蛋白质/脂肪。
- **次日自动重置**：跨日自动恢复默认推荐值，并支持手动“恢复默认”。
- **环形颜色提示**：进度环根据摄入占比自动切换绿色/橙色/红色。

### 饮食记录编辑 + 报表容错强化

- **编辑入口**：饮食记录列表支持编辑重量与餐次。
- **报表容错**：日报数据缺失/异常时自动归零并安全计算进度条。

### 健康档案入口与基础骨架

- **个人中心新增卡片**：健康档案进度 + 饮食管理摘要卡片。
- **健康档案页面**：新增健康档案页，支持基础信息录入与本地保存。

### 健康档案 BMI 自动计算 + 饮食建议

- **BMI 实时计算**：基于身高体重自动计算 BMI 并显示状态（偏低/正常/超重/肥胖）。
- **饮食建议卡片**：根据 BMI 输出简洁饮食建议，档案未完整时提示完善信息。
- **AI 健康建议**：调用 DeepSeek 生成饮食/运动双行建议，并标注 AI 建议来源。
- **建议更新时间**：展示最近一次建议更新时间，便于用户理解内容时效性。
- **BMI 状态色**：正常为绿色，偏低为蓝色，超重为橙色，肥胖为红色强调。
- **记录编辑修复**：更新记录接口支持仅提交餐次/重量等局部字段，避免 422 校验失败。
- **多模型识别兜底**：菜品识别置信度不足时自动切换果蔬/植物识别，保证识别结果可继续生成营养与健康提示。
- **状态接口补充**：`/api/v1/status` 增加 `deepseek_configured` 字段，方便确认 AI 是否正确加载。
- **DeepSeek 营养分析修复**：修正营养分析函数误返回 `None` 的问题，确保识别结果可正常生成营养/建议数据。
- **识别图片质量优化**：选择图片时使用原图模式（sizeType=original），避免自动压缩导致识别偏差。
- **多模型选优策略**：菜品/果蔬/植物同时识别并按置信度择优，减少番茄类蔬果被误判。

**技术实现：**

- **后端新增**：`food_temp` 临时表、`allow_guest_history` 配置、history 可选登录逻辑。
- **前端新增**：请求拦截 `utils/http.ts`，来源徽章展示与批量添加流程。

---

## 2026-01-27 DeepSeek AI 营养分析 + 智能热量估算 🤖🍽️

### DeepSeek AI 营养数据生成

当本地数据库没有收录食物信息时，现在会自动调用 DeepSeek AI 生成完整的营养和健康数据。

**功能亮点：**

- **智能营养分析**：AI 自动估算热量、蛋白质、脂肪、碳水化合物，并生成健康评级和饮食建议。
- **GI 值（血糖生成指数）**：新增 GI 指标，帮助控糖/减肥用户做出更科学的饮食选择。低 GI（绿色）/ 中 GI（橙色）/ 高 GI（红色）直观展示。
- **禁忌人群提醒**：AI 自动识别不适宜人群（糖尿病、高血压、痛风等），标注严重程度。
- **数据校验机制**：对 AI 返回数据进行合理性验证，防止异常值（如热量为负、脂肪超 100g 等）。
- **优雅降级**：DeepSeek API 不可用时，自动降级为仅显示百度热量数据。

### 识别历史自动保存 📋

**问题**：识别成功后未自动保存到历史记录，导致历史页面始终为空。

**修复**：在结果页 `onMounted` 中新增 `saveToHistory()` 函数，识别成功后自动调用 `POST /api/v1/history` 保存记录（需登录）。

### 历史记录详情缓存 ✅

**功能**：识别历史列表支持点击查看详情，直接加载当时的完整识别结果（包括 AI 分析数据），无需重复消耗 Token 调用 API。

**技术实现：**

- **数据库**：`RecognitionHistory` 表新增 `result_data` 字段，存储完整 JSON 数据。
- **前端优化**：
  - 识别成功保存时，将 `resultData` 序列化并上传。
  - 历史列表点击时，将 `result_data` 传递给结果页复用展示。
  - 结果页增加 `from=history` 参数判断，避免查看历史时重复创建记录。

**技术实现：**

- **后端新增**：
  - 创建 `app/services/deepseek_service.py`，封装 DeepSeek API 调用、Prompt 设计、结果解析与校验。
  - 修改 `app/config.py`，新增 `DEEPSEEK_API_KEY`、`DEEPSEEK_BASE_URL` 配置项。
  - 修改 `app/schemas/recognition.py`，新增 `gi`、`ai_generated` 字段。
  - 修改 `app/api/v1/recognition.py`，集成 DeepSeek 服务，实现本地→AI 的智能切换。
- **前端优化**：
  - 新增 🤖 AI 估算标记，区分数据库数据与 AI 生成数据。
  - 新增 GI 值显示区域，颜色编码直观展示血糖影响。

### 餐具热量估算器 🍽️

针对 AI 生成数据的场景，原有的"份量选择 + 烹饪方式"不再适用。我们重构了热量计算逻辑。

**功能亮点：**

- **本地数据库有数据**：保留原有份量（小/中/大份）+ 烹饪方式选择，调用后端精确计算。
- **AI 生成数据**：切换为餐具估算模式，用户选择餐具类型，前端直接计算。
  - 一小碗 = 150g
  - 一碗 = 250g
  - 一盘 = 300g
  - 一大盘 = 450g

**技术实现：**

- **前端重构**：
  - 修改 `pages/result/index.vue`，根据 `found_in_database` 动态切换 UI 模式。
  - 新增 `dishSizes` 餐具配置、`calculateByDish()` 计算函数。

### 百度 AI 配置优化 📷

- **启动状态检查**：服务启动时显示百度 AI 和 DeepSeek 的配置状态，便于快速定位问题。
- **热量字段透传**：将百度返回的 `calorie` 字段传递到前端，当本地和 AI 均无数据时作为兜底展示。

### 修复 (Fixes)

- **图片大小限制**：优化日志输出，显示图片大小和 Base64 编码后长度，便于排查超限问题。
- **配置状态日志**：`main.py` 启动时打印 DeepSeek 配置状态，便于确认是否正确加载。
- **数据库 Schema 修复**：修复了 `RecognitionHistory` 表缺少 `result_data` 字段导致的 500 错误，通过重置数据库应用了最新的 Schema。

---

## 2026-01-26 百度 AI 菜品识别接入 📷

### 核心识别功能

- **百度 AI 接入**：集成百度菜品识别 API，支持上传实拍照片识别菜品名称。
- **置信度排序**：返回多个候选结果，按匹配度降序排列。
- **模拟数据兜底**：未配置 API 时自动使用模拟数据，便于开发测试。

---

## 2026-01-25 用户系统与历史记录 👤

### 用户功能

- **注册/登录**：基于 JWT 的无状态认证，支持 Token 刷新。
- **个人中心**：展示用户基本信息，支持修改昵称等。
- **识别历史**：保存每次识别结果，支持分页查询和删除。

### 技术实现

- **数据库模型**：新增 `User`、`RecognitionHistory` 表。
- **API 接口**：`/api/v1/user/register`、`/api/v1/user/login`、`/api/v1/history`。

---

## 2026-01-24 基础框架搭建 🏗️

### 项目初始化

- **后端**：FastAPI + SQLAlchemy + Pydantic，OpenAPI 文档自动生成。
- **前端**：UniApp (Vue 3 + TypeScript)，支持 H5 / 小程序多端。
- **数据库**：SQLite 本地存储，30+ 常见菜品初始数据。

### 核心 API

- `/api/v1/recognize`：食物识别
- `/api/v1/food`：食物查询
- `/api/v1/calculate/calories`：卡路里计算
